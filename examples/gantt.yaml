version: gantt 0.0.1
usage: |
  gantt
  
  Usage:
    gantt [options] [<src>]

  Options:
    -h --help          Show this screen.
    -v --version       Show version.
    -o --ouput=FILE    Output file [default: stdout].
    -c, --config=FILE  Path to a YAML config file for Gantt chart

tokens:
  config: ^(.*?\n)---
  text: (\w[\w ]*)
  -----: ---+
  ===: ([ =]*=)
  <>: <(.*?)>

grammar:
  start:
    - config gantt
    - gantt
  gantt: | 
    text
    -----
    titles
    rows
    -----
  titles:
    - titles | text
    - "| text"
  rows:
    - rows row
    - row
  row: 
    - text | ===
    - text | === <>

code:
  main: | # py
    import yaml
    from pylatex import Package
    from pylatex.base_classes import Environment, Command, CommandBase, ContainerCommand
    from pylatex.utils import NoEscape

    class GanttChart(Environment):
      packages = [Package('pgfgantt')]
      content_separator = "\n"
    class ResizeBox(ContainerCommand): pass
    class GanttTitle(CommandBase): pass
    class GanttBar(CommandBase): pass
    class GanttMilestone(CommandBase): pass
    
    return start()
  start:
    - gantt(config=yaml.safe_load(config[1]))
    - gantt(config={})
  gantt: | # py
    title_width = config.get('title_width', 4)
    options = config.get('options', [])
    default_options = [
      'vgrid', 'hgrid', 'x unit = 1cm', 'y unit = 1cm', 
      'bar/.append style={fill = lightgray}'
    ]
    options = map(NoEscape, default_options + options)
    titles = titles()

    gantt = GanttChart(options=options, arguments=[start, len(titles)])
    gantt.append(GanttTitle(arguments=[text[1], len(titles) * title_width]))
    gantt.append(NoEscape(r'\\'))

    for title in titles:
      gantt.append(GanttTitle(arguments=[title, title_width]))
    gantt.append(NoEscape(r'\\'))

    rows = rows()
    for text, (start, end), milestone in rows:
      gantt.append(GanttBar(arguments=[text, start, end]))
      if milestone != None:
        gantt.append(GanttMilestone(options='inline', arguments=[milestone, end]))
      gantt.append(NoEscape(r'\\'))

    return NoEscape(r'\noindent') + ResizeBox(arguments=[Command('textwidth'), '!'], data=gantt).dumps()
  titles:
    - titles() + [text[1]]
    - "[text[1]]"
  rows:
    - rows() + [row()]
    - "[row()]"
  row:
    - | # py
      bar = vars()['==='][1]
      (text[1], (bar.find('='), bar.rfind('=')), None)
    - | # py
      bar = vars()['==='][1]
      (text[1], (bar.find('='), bar.rfind('=')), vars()['<>'][1])

requirements: | # pip
  PyLaTex==1.4.1
  PyYaml
